# Maintainer: Jose G Perez Taveras <josegpt27@gmail.com>
# Contributor: Jose G Perez Taveras <josegpt27@gmail.com>
pkgname=emacs
pkgver=29.0.50
pkgrel=0
pkgdesc="The extensible, customizable, self-documenting real-time display editor"
arch="all"
url="https://www.gnu.org/software/emacs/emacs.html"
license="GPL-3.0-or-later"
makedepends="autoconf texinfo automake linux-headers gawk ncurses-dev
	ncurses-libs gnutls-dev gmp-dev jansson-dev harfbuzz-dev glib-dev
	fontconfig-dev libpng-dev librsvg-dev giflib-dev libxpm-dev
	alsa-lib-dev libxml2-dev pango-dev tiff-dev libjpeg-turbo-dev
	libwebp-dev libxaw-dev libgccjit-dev"
subpackages="$pkgname-doc"
source="https://git.savannah.gnu.org/cgit/emacs.git/snapshot/emacs-master.tar.gz"
builddir="$srcdir/$pkgname-master"

prepare() {
	default_prepare
	./autogen.sh
	CFLAGS=-fno-pie \
	LDFLAGS=-no-pie \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--libexecdir=/usr/lib \
		--localstatedir=/var \
		--without-selinux \
		--without-libsystemd \
		--without-toolkit-scroll-bars \
		--without-dbus \
		--without-gconf \
		--without-gsettings \
		--with-gameuser=:games \
		--without-xaw3d \
		--with-gpm \
		--with-harfbuzz \
		--with-json \
		--with-webp \
		--with-native-compilation \
		--with-x-toolkit=lucid \
		--with-xft \
		--with-jpeg=yes \
		--with-tiff=yes \
		"${@}"
}

build() {
	make
}

package() {
	make DESTDIR="$pkgdir" install

	# remove conflict with ctags package
	mv "$pkgdir"/usr/bin/ctags "$pkgdir"/usr/bin/ctags.emacs

	# fix user/root permissions on usr/share files
	find "$pkgdir"/usr/share/emacs/ -exec chown root:root {} \;
	find "$pkgdir"/usr/lib -perm -g+s,g+x ! -type d -exec chmod g-s {} \;
	# fix perms on /var/games
	chmod 775 "$pkgdir"/var/games
	chmod 775 "$pkgdir"/var/games/emacs
	chmod 664 "$pkgdir"/var/games/emacs/*
	chown -R root:games "$pkgdir"/var/games

	rm -rf "$pkgdir"/usr/share/appdata \
		"$pkgdir"/usr/share/applications \
		"$pkgdir"/usr/share/icons \
		"$pkgdir"/usr/lib/systemd
}

doc() {
	mkdir -p "$subpkgdir"/usr/share || return 1
	mv "$pkgdir"/usr/share/man "$subpkgdir"/usr/share \
			|| return 1
	mv "$pkgdir"/usr/share/info "$subpkgdir"/usr/share \
			|| return 1
}

sha512sums="
0fd226f1d1b6f5ad3412ea09155391f9655ff257e31ea69a8d33244ded3799c055fa6a088bd63f13404a244c35bd069fc1faa8cd7d7b196b414004af8dd20f04  emacs-master.tar.gz
"
